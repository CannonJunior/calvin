<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Earnings Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script type="module" src="./dist/dashboard-integration.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Top scrolling ticker */
        .ticker-container {
            background: linear-gradient(90deg, #1a1a2e, #16213e, #0f3460);
            height: 50px;
            overflow: hidden;
            border-bottom: 1px solid #333;
            position: relative;
        }

        .ticker-content {
            display: flex;
            animation: scroll 30s linear infinite;
            white-space: nowrap;
            align-items: center;
            height: 100%;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .ticker-item {
            margin-right: 40px;
            font-size: 14px;
            font-weight: 600;
            color: #64ffda;
        }

        .ticker-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            border-radius: 4px;
        }

        .ticker-menu select {
            background: transparent;
            color: white;
            border: none;
            padding: 8px;
            font-size: 12px;
        }

        /* Main layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 50px);
        }

        /* Sidebar */
        .sidebar {
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #64ffda;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .favorites-list {
            margin-bottom: 30px;
        }

        .list-item {
            background: #2a2a2a;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background: #3a3a3a;
            transform: translateX(5px);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-name {
            font-weight: 600;
            font-size: 14px;
        }

        .list-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #4a90e2;
            color: white;
        }

        .list-type.sandbox {
            background: #ff6b6b;
        }

        .stock-count {
            font-size: 12px;
            color: #888;
        }

        /* Main content */
        .main-content {
            display: flex;
            flex-direction: column;
        }

        /* MCP Tools section */
        .mcp-tools {
            background: linear-gradient(90deg, #2d1b69, #11998e);
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
        }

        /* Company Search */
        .company-search-container {
            position: relative;
            margin-right: 15px;
        }

        .company-search-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            width: 200px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .company-search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .company-search-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        /* Autocomplete Panel */
        .autocomplete-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #333;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
            margin-top: 5px;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.2s ease;
        }

        .autocomplete-item:hover {
            background: rgba(100, 255, 218, 0.1);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-symbol {
            font-weight: 600;
            color: #64ffda;
            font-size: 13px;
        }

        .autocomplete-name {
            color: #ffffff;
            font-size: 12px;
            margin: 2px 0;
        }

        .autocomplete-sector {
            color: #888;
            font-size: 11px;
        }

        /* Highlighted earnings icons */
        .earnings-icon.highlighted {
            filter: drop-shadow(0 0 8px #ffeb3b) saturate(1.5);
            stroke: #ffeb3b;
            stroke-width: 2;
        }

        .mcp-tool {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mcp-tool:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        /* Timeline container */
        .timeline-container {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 35%, #0f3460 100%);
        }

        .timeline-svg {
            width: 100%;
            height: 100%;
        }

        .current-date-line {
            stroke: #ff3333;
            stroke-width: 2;
            opacity: 0.8;
        }

        .earnings-icon {
            cursor: pointer;
            transition: filter 0.3s ease;
        }

        .earnings-icon:hover {
            filter: drop-shadow(0 0 10px rgba(100, 255, 218, 0.8));
        }

        .past-icon {
            fill-opacity: 0.8;
        }

        .future-icon {
            fill-opacity: 0.6;
            stroke: #64ffda;
            stroke-width: 1;
        }

        /* Color coding for prediction accuracy */
        .poor-prediction { fill: #ff4444; }
        .moderate-prediction { fill: #888888; }
        .great-prediction { fill: #4444ff; }

        /* Future prediction confidence */
        .low-confidence { fill: #ff6b6b; }
        .medium-confidence { fill: #ffd93d; }
        .high-confidence { fill: #6bcf7f; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #64ffda;
            backdrop-filter: blur(10px);
        }

        /* Pinned info container */
        .pinned-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-size: 13px;
            z-index: 1001;
            border: 2px solid #64ffda;
            cursor: move;
            min-width: 300px;
            backdrop-filter: blur(15px);
        }

        .pinned-info .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Chat interface */
        .chat-container {
            background: #1a1a1a;
            border-top: 1px solid #333;
            padding: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .model-selector {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .config-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .getting-started {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
            justify-content: flex-end;
        }

        .quick-action {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #64ffda;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            background: #3a3a3a;
            border-color: #64ffda;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            height: 60px;
            flex: 1;
        }

        .chat-input:focus {
            outline: none;
            border-color: #64ffda;
        }

        .chat-send-btn {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            height: 60px;
            min-width: 80px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:enabled:hover {
            background: #5ba0f2;
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .chat-send-btn:disabled:hover {
            transform: none;
        }

        /* Configuration modal */
        .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .config-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h4 {
            color: #64ffda;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .config-group {
            margin-bottom: 15px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #ccc;
        }

        .config-group input,
        .config-group select {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .config-group input[type="range"] {
            height: 6px;
        }

        .config-buttons {
            text-align: right;
            margin-top: 20px;
        }

        .config-buttons button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-cancel {
            background: #666;
            color: white;
        }

        .btn-save {
            background: #4a90e2;
            color: white;
        }

        /* Chat history styles */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 15px;
            min-height: 150px;
            scrollbar-width: thin;
            scrollbar-color: #555 transparent;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message:last-child {
            margin-bottom: 0;
        }

        .chat-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .chat-icon.user {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .chat-icon.assistant {
            background: linear-gradient(135deg, #777, #333);
            color: white;
        }

        .chat-icon.error {
            background: linear-gradient(135deg, #ff6b6b, #e74c3c);
            color: white;
        }

        .chat-message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .chat-message.user .chat-message-content {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            margin-left: 0;
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant .chat-message-content {
            background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
            color: #e8e8e8;
            border: 1px solid #444;
            border-bottom-left-radius: 4px;
        }

        .chat-message.error .chat-message-content {
            background: linear-gradient(135deg, #ff6b6b, #e74c3c);
            color: white;
            border-bottom-left-radius: 4px;
        }

        .chat-message-header {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 6px;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-message-time {
            font-size: 11px;
            opacity: 0.7;
            font-weight: normal;
        }

        .chat-message-text {
            line-height: 1.6;
        }

        /* Financial data highlighting in chat */
        .chat-message-text .stock-symbol {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .chat-message-text .price {
            color: #6bcf7f;
            font-weight: 600;
        }

        .chat-message-text .percentage {
            font-weight: 600;
        }

        .chat-message-text .percentage.positive {
            color: #6bcf7f;
        }

        .chat-message-text .percentage.negative {
            color: #ff6b6b;
        }

        /* Loading message animation */
        .chat-message.loading .chat-message-content {
            background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
            border: 1px solid #444;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64ffda;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Loading animation */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                height: auto;
                max-height: 200px;
            }

            .chat-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chat-header-left {
                width: 100%;
                justify-content: space-between;
            }

            .getting-started {
                width: 100%;
                justify-content: flex-start;
            }

            .quick-action {
                font-size: 10px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Top scrolling ticker -->
    <div class="ticker-container">
        <div class="ticker-content" id="ticker">
            <span class="ticker-item">Loading real market data...</span>
        </div>
        <div class="ticker-menu">
            <select id="ticker-type">
                <option value="sector">By Sector</option>
                <option value="earnings">Upcoming Earnings</option>
                <option value="volume">By Volume</option>
                <option value="news">Trending News</option>
                <option value="social">Social Feed</option>
            </select>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3>Portfolio Manager</h3>
            <div class="favorites-list" id="portfolio-list">
                <!-- Portfolio items will be populated with real sector data -->
                <div class="list-item">
                    <div class="list-header">
                        <span class="list-name">Loading S&P 500 sectors...</span>
                        <span class="list-type">API</span>
                    </div>
                    <div class="stock-count">Loading...</div>
                </div>
            </div>

            <h3>Configuration</h3>
            <div class="config-group">
                <label>Icon Size</label>
                <select id="icon-size">
                    <option value="equal">Equal Size</option>
                    <option value="market-cap">By Market Cap</option>
                    <option value="volume">By Volume</option>
                    <option value="short-interest">By Short Interest</option>
                    <option value="pe-ratio">By P/E Ratio</option>
                    <option value="90day-performance">90-Day Performance</option>
                </select>
            </div>
            
            <div class="config-group">
                <label>Y-Axis Positioning</label>
                <select id="y-axis-mode">
                    <option value="confidence">Confidence</option>
                    <option value="price-change">Price Change</option>
                    <option value="surprise-percent">Surprise %</option>
                    <option value="eps-growth">EPS Growth</option>
                    <option value="market-cap">Market Cap</option>
                </select>
            </div>
            
            <div class="config-group">
                <label>Color Scheme</label>
                <select id="color-scheme">
                    <option value="default">Default (Red/Gray/Blue)</option>
                    <option value="traffic">Traffic Light</option>
                    <option value="heatmap">Heatmap</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- MCP Tools -->
            <div class="mcp-tools">
                <!-- Company Search -->
                <div class="company-search-container">
                    <input type="text" 
                           class="company-search-input" 
                           id="company-search"
                           placeholder="🔍 Search S&P 500 companies..."
                           autocomplete="off">
                    <div class="autocomplete-panel" id="autocomplete-panel"></div>
                </div>
                <div class="mcp-tool" onclick="performSentimentAnalysis()">📊 Sentiment Analysis</div>
                <div class="mcp-tool" onclick="findSimilarCompanies()">🔍 Find Similar Companies</div>
                <div class="mcp-tool" onclick="addIPOCompanies()">📈 Add IPO Companies</div>
                <div class="mcp-tool" onclick="analyzeOptions()">📋 Options Analysis</div>
                <div class="mcp-tool" onclick="marketCorrelation()">🔗 Market Correlation</div>
            </div>

            <!-- Timeline -->
            <div class="timeline-container">
                <svg class="timeline-svg" id="timeline"></svg>
            </div>

            <!-- Chat interface -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <select class="model-selector" id="model-select">
                            <option value="qwen:1.8b" selected>Qwen 1.8B</option>
                            <option value="gemma3:1b">Gemma3 1B</option>
                            <option value="llama3.1:1b">Llama 3.1 1B</option>
                            <option value="codellama:7b">CodeLlama 7B</option>
                            <option value="llama3.1:8b">Llama 3.1 8B</option>
                        </select>
                        <button class="config-btn" onclick="openConfigModal()">⚙️ Configure Model</button>
                    </div>
                    
                    <div class="getting-started">
                        <div class="quick-action" onclick="populateChatInput('Analyze AAPL earnings performance')">📊 Analyze AAPL earnings</div>
                        <div class="quick-action" onclick="populateChatInput('What sectors are showing strength?')">🏭 Sector analysis</div>
                        <div class="quick-action" onclick="populateChatInput('Upcoming earnings this week')">📅 This week's earnings</div>
                        <div class="quick-action" onclick="populateChatInput('Compare my portfolio to S&P 500')">📈 Portfolio comparison</div>
                    </div>
                </div>
                
                <!-- Chat History -->
                <div class="chat-history" id="chat-history">
                    <!-- Welcome message -->
                    <div class="chat-message assistant">
                        <div class="chat-icon assistant">🦸</div>
                        <div class="chat-message-content">
                            <div class="chat-message-header">
                                Assistant
                                <span class="chat-message-time">Welcome</span>
                            </div>
                            <div class="chat-message-text">
                                Hello! I'm your financial analysis assistant. I can help you analyze stocks, earnings, and market trends. 
                                Ask me anything about the companies shown on the timeline above, or use the quick actions above to get started.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea class="chat-input" placeholder="Ask questions about stocks, earnings, or request analysis..." id="chat-input"></textarea>
                    <button class="chat-send-btn" id="chat-send-btn" disabled>
                        <span>Send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <!-- Configuration Modal -->
    <div class="config-modal" id="config-modal">
        <div class="config-content">
            <h3 style="color: #64ffda; margin-bottom: 20px;">Ollama Model Configuration</h3>
            
            <div class="config-section">
                <h4>Model Parameters</h4>
                <div class="config-group">
                    <label>Temperature (0.0 - 2.0)</label>
                    <input type="range" min="0" max="2" step="0.1" value="0.7" id="temperature">
                    <span id="temp-value">0.7</span>
                </div>
                <div class="config-group">
                    <label>Top P (0.0 - 1.0)</label>
                    <input type="range" min="0" max="1" step="0.05" value="0.9" id="top-p">
                    <span id="top-p-value">0.9</span>
                </div>
                <div class="config-group">
                    <label>Max Tokens</label>
                    <input type="number" min="1" max="4096" value="2048" id="max-tokens">
                </div>
                <div class="config-group">
                    <label>Context Length</label>
                    <input type="number" min="512" max="32768" value="4096" id="context-length">
                </div>
            </div>

            <div class="config-section">
                <h4>Generation Settings</h4>
                <div class="config-group">
                    <label>Repetition Penalty</label>
                    <input type="range" min="0.5" max="2.0" step="0.1" value="1.1" id="rep-penalty">
                    <span id="rep-penalty-value">1.1</span>
                </div>
                <div class="config-group">
                    <label>Top K</label>
                    <input type="number" min="1" max="100" value="40" id="top-k">
                </div>
                <div class="config-group">
                    <label>Seed (for reproducibility)</label>
                    <input type="number" value="-1" id="seed">
                </div>
            </div>

            <div class="config-section">
                <h4>System Prompt</h4>
                <div class="config-group">
                    <label>Custom System Prompt</label>
                    <textarea style="height: 100px;" id="system-prompt" placeholder="You are a financial analyst assistant...">You are an expert financial analyst with deep knowledge of stock markets, earnings analysis, and investment strategies. Provide accurate, actionable insights while maintaining a professional tone.</textarea>
                </div>
            </div>

            <div class="config-section">
                <h4>Performance Settings</h4>
                <div class="config-group">
                    <label>GPU Layers</label>
                    <input type="number" min="0" max="50" value="-1" id="gpu-layers">
                </div>
                <div class="config-group">
                    <label>Thread Count</label>
                    <input type="number" min="1" max="16" value="4" id="threads">
                </div>
                <div class="config-group">
                    <label>Batch Size</label>
                    <input type="number" min="1" max="512" value="128" id="batch-size">
                </div>
            </div>

            <div class="config-buttons">
                <button class="btn-cancel" onclick="closeConfigModal()">Cancel</button>
                <button class="btn-save" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        // REAL DATA CONFIGURATION
        // Data is now served via HTTP API from Wikipedia-sourced S&P 500 list (503 companies)
        // To use real market data, sign up for free API keys:
        // 1. Alpha Vantage: https://www.alphavantage.co/support/#api-key (25 requests/day free)
        // 2. Finnhub: https://finnhub.io/register (60 requests/minute free)
        // 3. Financial Modeling Prep: https://financialmodelingprep.com/developer/docs (500MB/month free)
        // Replace 'demo' with your actual API keys below
        
        // API Configuration - loaded from external config file
        let API_CONFIG = {};

        // Load configuration from external file
        async function loadConfig() {
            try {
                const response = await fetch('./config.json');
                if (!response.ok) {
                    throw new Error(`Failed to load config: ${response.status}`);
                }
                const config = await response.json();
                
                API_CONFIG = {
                    ALPHA_VANTAGE_KEY: config.api_keys.alpha_vantage,
                    FINNHUB_KEY: config.api_keys.finnhub,
                    FMP_KEY: config.api_keys.financial_modeling_prep,
                    BASE_URL_AV: config.api_endpoints.alpha_vantage_base,
                    BASE_URL_FH: config.api_endpoints.finnhub_base,
                    BASE_URL_FMP: config.api_endpoints.fmp_base,
                    SP500_API: config.api_endpoints.sp500_api,
                    EARNINGS_API: config.api_endpoints.earnings_api
                };
                
                console.log('✅ Configuration loaded successfully');
                return true;
            } catch (error) {
                console.error('❌ Failed to load configuration:', error);
                console.log('🔄 Falling back to demo configuration...');
                
                // Fallback configuration
                API_CONFIG = {
                    ALPHA_VANTAGE_KEY: 'demo',
                    FINNHUB_KEY: 'demo',
                    FMP_KEY: 'demo',
                    BASE_URL_AV: 'https://www.alphavantage.co/query',
                    BASE_URL_FH: 'https://finnhub.io/api/v1',
                    BASE_URL_FMP: 'https://financialmodelingprep.com/api/v3',
                    SP500_API: 'http://localhost:5001/api',
                    EARNINGS_API: 'http://localhost:5002/api'
                };
                
                return false;
            }
        }

        // S&P 500 companies data (loaded from API)
        let sp500Companies = [];
        let sp500CompaniesData = [];
        let sp500SectorsData = [];

        // Real data storage
        let realEarningsData = [];
        let realTickerData = {};

        // Fetch real market data from Alpha Vantage
        async function fetchRealMarketData(symbols, maxSymbols = 10) {
            const data = [];
            const fetchPromises = [];
            
            // Limit API calls to avoid rate limits
            const symbolsToFetch = symbols.slice(0, maxSymbols);
            
            for (const symbol of symbolsToFetch) {
                const promise = fetchStockData(symbol);
                fetchPromises.push(promise);
            }
            
            try {
                const results = await Promise.allSettled(fetchPromises);
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value) {
                        data.push(result.value);
                    } else {
                        console.warn(`Failed to fetch data for ${symbolsToFetch[index]}`);
                    }
                });
            } catch (error) {
                console.error('Error fetching real market data:', error);
            }
            
            return data;
        }

        // Fetch individual stock data
        async function fetchStockData(symbol) {
            try {
                // Use Financial Modeling Prep for current price data
                const url = `${API_CONFIG.BASE_URL_FMP}/quote/${symbol}?apikey=${API_CONFIG.FMP_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const quote = data[0];
                
                if (!quote) {
                    console.warn(`No data returned for ${symbol}`);
                    return null;
                }
                
                return {
                    symbol: quote.symbol,
                    price: parseFloat(quote.price),
                    change: parseFloat(quote.change),
                    changePercent: parseFloat(quote.changesPercentage),
                    volume: parseInt(quote.volume),
                    previousClose: parseFloat(quote.previousClose),
                    high: parseFloat(quote.dayHigh),
                    low: parseFloat(quote.dayLow),
                    marketCap: parseFloat(quote.marketCap),
                    lastUpdated: quote.timestamp,
                    dataSource: url // Include the actual API URL used
                };
            } catch (error) {
                console.error(`Error fetching data for ${symbol}:`, error);
                return null;
            }
        }

        // Fetch historical market cap for a specific date
        async function fetchHistoricalMarketCap(symbol, date) {
            try {
                const dateStr = date.toISOString().split('T')[0];
                const url = `${API_CONFIG.BASE_URL_FMP}/historical-market-capitalization/${symbol}?from=${dateStr}&to=${dateStr}&apikey=${API_CONFIG.FMP_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        marketCap: parseFloat(data[0].marketCap) / 1000000000, // Convert to billions
                        dataSource: url
                    };
                }
                
                return { marketCap: null, dataSource: url };
            } catch (error) {
                console.error(`Error fetching historical market cap for ${symbol} on ${date}:`, error);
                return { marketCap: null, dataSource: `${API_CONFIG.BASE_URL_FMP}/historical-market-capitalization/${symbol}` };
            }
        }

        // Fetch historical price data for earnings date analysis
        async function fetchHistoricalPriceChange(symbol, earningsDate) {
            try {
                const earningsDateStr = earningsDate.toISOString().split('T')[0];
                const nextDay = new Date(earningsDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayStr = nextDay.toISOString().split('T')[0];
                
                // Get price data for the earnings date and the next trading day
                const url = `${API_CONFIG.BASE_URL_FMP}/historical-price-full/${symbol}?from=${earningsDateStr}&to=${nextDayStr}&apikey=${API_CONFIG.FMP_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const historical = data.historical;
                
                if (historical && historical.length >= 2) {
                    const earningsPrice = parseFloat(historical[1].close); // Day of earnings
                    const nextDayPrice = parseFloat(historical[0].close); // Day after earnings
                    const priceChange = ((nextDayPrice - earningsPrice) / earningsPrice) * 100;
                    
                    return {
                        priceChange: priceChange,
                        earningsPrice: earningsPrice,
                        nextDayPrice: nextDayPrice,
                        dataSource: url
                    };
                } else if (historical && historical.length === 1) {
                    // Only one day of data available
                    return {
                        priceChange: 0,
                        earningsPrice: parseFloat(historical[0].close),
                        nextDayPrice: parseFloat(historical[0].close),
                        dataSource: url
                    };
                }
                
                return { priceChange: null, dataSource: url };
            } catch (error) {
                console.error(`Error fetching historical price change for ${symbol} on ${earningsDate}:`, error);
                return { priceChange: null, dataSource: `${API_CONFIG.BASE_URL_FMP}/historical-price-full/${symbol}` };
            }
        }

        // Fetch earnings calendar data
        async function fetchEarningsCalendar() {
            try {
                // Use Finnhub earnings calendar
                const today = new Date();
                const from = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const to = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const url = `${API_CONFIG.BASE_URL_FH}/calendar/earnings?from=${from}&to=${to}&token=${API_CONFIG.FINNHUB_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Filter for S&P 500 companies and process data
                const filteredEarnings = data.earningsCalendar?.filter(earning => 
                    sp500Companies.includes(earning.symbol)
                ) || [];
                
                return filteredEarnings.map(earning => ({
                    symbol: earning.symbol,
                    date: new Date(earning.date),
                    type: new Date(earning.date) < new Date() ? 'past' : 'future',
                    eps: earning.eps,
                    epsEstimate: earning.epsEstimate,
                    hour: earning.hour,
                    quarter: earning.quarter,
                    revenueEstimate: earning.revenueEstimate,
                    revenue: earning.revenue,
                    year: earning.year
                }));
            } catch (error) {
                console.error('Error fetching earnings calendar:', error);
                return [];
            }
        }

        // Fetch real earnings data from PostgreSQL with enhanced historical data
        async function fetchRealEarningsData() {
            try {
                console.log('📊 Fetching real earnings data from PostgreSQL...');
                
                const response = await fetch(`${API_CONFIG.EARNINGS_API}/earnings/timeline`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const timelineData = data.timeline_data || [];
                
                console.log(`✅ Loaded ${timelineData.length} real earnings events from database`);
                console.log('📈 Fetching historical market data for each earnings event...');
                
                // Enhance earnings data with real historical market cap and price changes
                const enhancedData = await Promise.all(timelineData.map(async (item) => {
                    const earningsDate = new Date(item.date);
                    const symbol = item.symbol;
                    
                    // Fetch historical market cap for the earnings date
                    const marketCapData = await fetchHistoricalMarketCap(symbol, earningsDate);
                    
                    // Fetch price change data for past earnings only
                    let priceChangeData = { priceChange: null, dataSource: null };
                    if (item.type === 'past') {
                        priceChangeData = await fetchHistoricalPriceChange(symbol, earningsDate);
                    }
                    
                    return {
                        symbol: item.symbol,
                        company_name: item.company_name,
                        date: earningsDate,
                        type: item.type,
                        sector: item.sector,
                        
                        // Enhanced price and prediction data with real API data
                        priceChange: priceChangeData.priceChange !== null ? priceChangeData.priceChange : (parseFloat(item.priceChange) || 0),
                        predictionAccuracy: parseFloat(item.predictionAccuracy) || 0.5,
                        marketCap: marketCapData.marketCap !== null ? marketCapData.marketCap : (parseFloat(item.marketCap) || 1000),
                        volume: parseInt(item.volume) || 50000000,
                        
                        // Earnings specific data
                        actualEPS: parseFloat(item.actualEPS) || null,
                        expectedEPS: parseFloat(item.expectedEPS) || null,
                        beat_miss_meet: item.beat_miss_meet,
                        surprise_percent: parseFloat(item.surprise_percent) || null,
                        
                        // Future earnings
                        analystExpectation: item.analystExpectation || (item.type === 'future' ? 'meet' : null),
                        confidence: parseFloat(item.confidence) || 0.5,
                        consensusRating: item.consensusRating,
                        announcement_time: item.announcement_time,
                        
                        // Data source tracking - use stored source URL from database first
                        source_url: item.source_url || marketCapData.dataSource || priceChangeData.dataSource,
                        marketCapDataSource: marketCapData.dataSource,
                        priceChangeDataSource: priceChangeData.dataSource
                    };
                }));
                
                console.log('✅ Enhanced earnings data with real historical market data');
                return enhancedData.sort((a, b) => a.date - b.date);
                
            } catch (error) {
                console.error('❌ Error fetching real earnings data:', error);
                console.log('🔄 Falling back to mock data...');
                return generateMockEarningsData();
            }
        }

        // Generate combined real and estimated data (updated to use PostgreSQL)
        async function generateRealData() {
            try {
                // Fetch real market data for ticker
                const marketData = await fetchRealMarketData(sp500Companies, 15);
                realTickerData = marketData.reduce((acc, stock) => {
                    if (stock) {
                        acc[stock.symbol] = stock;
                    }
                    return acc;
                }, {});
                
                // Fetch real earnings data from PostgreSQL
                const earningsData = await fetchRealEarningsData();
                realEarningsData = earningsData;
                
                return realEarningsData;
            } catch (error) {
                console.error('Error generating real data:', error);
                // Fallback to mock data
                return generateMockEarningsData();
            }
        }

        // Fallback mock data generator (smaller, for supplementing real data)
        function generateMockEarningsData() {
            const data = [];
            const now = new Date();
            const limitedCompanies = sp500Companies.slice(0, 15);
            
            limitedCompanies.forEach((symbol) => {
                // Past earnings (last 2 quarters)
                for (let q = 0; q < 2; q++) {
                    const date = new Date(now);
                    date.setMonth(date.getMonth() - (q * 3) - Math.random() * 30);
                    
                    data.push({
                        symbol,
                        date,
                        type: 'past',
                        priceChange: (Math.random() - 0.5) * 20,
                        predictionAccuracy: Math.random(),
                        marketCap: Math.random() * 2000 + 100,
                        volume: Math.random() * 100000000 + 1000000,
                        sector: getSectorForSymbol(symbol),
                        actualEPS: (Math.random() * 5 + 0.5).toFixed(2),
                        expectedEPS: (Math.random() * 5 + 0.5).toFixed(2),
                        marketCapDataSource: `${API_CONFIG.BASE_URL_FMP}/historical-market-capitalization/${symbol}?apikey=${API_CONFIG.FMP_KEY}`,
                        priceChangeDataSource: `${API_CONFIG.BASE_URL_FMP}/historical-price-full/${symbol}?apikey=${API_CONFIG.FMP_KEY}`
                    });
                }
                
                // Future earnings (next 2 quarters)
                for (let q = 0; q < 2; q++) {
                    const date = new Date(now);
                    date.setMonth(date.getMonth() + (q * 3) + Math.random() * 30);
                    
                    data.push({
                        symbol,
                        date,
                        type: 'future',
                        analystExpectation: Math.random() > 0.5 ? 'beat' : Math.random() > 0.5 ? 'meet' : 'miss',
                        confidence: Math.random(),
                        marketCap: Math.random() * 2000 + 100,
                        volume: Math.random() * 100000000 + 1000000,
                        sector: getSectorForSymbol(symbol),
                        expectedEPS: (Math.random() * 5 + 0.5).toFixed(2),
                        consensusRating: ['Buy', 'Hold', 'Sell'][Math.floor(Math.random() * 3)],
                        marketCapDataSource: `${API_CONFIG.BASE_URL_FMP}/historical-market-capitalization/${symbol}?apikey=${API_CONFIG.FMP_KEY}`,
                        priceChangeDataSource: null // Future earnings don't have price change data yet
                    });
                }
            });
            
            return data;
        }

        // Helper function to get sector for symbol (now using API data)
        function getSectorForSymbol(symbol) {
            // Try to find the company in the loaded data first
            const company = sp500CompaniesData.find(c => c.symbol === symbol);
            if (company && company.gics_sector) {
                return company.gics_sector;
            }
            
            // Fallback to hardcoded mapping for backward compatibility
            const sectors = {
                'AAPL': 'Information Technology', 'MSFT': 'Information Technology', 'GOOGL': 'Communication Services', 'META': 'Communication Services', 'NVDA': 'Information Technology',
                'TSLA': 'Consumer Discretionary', 'AMZN': 'Consumer Discretionary', 'NFLX': 'Communication Services', 'DIS': 'Communication Services',
                'JPM': 'Financials', 'BAC': 'Financials', 'V': 'Financials', 'MA': 'Financials',
                'JNJ': 'Health Care', 'UNH': 'Health Care', 'PFE': 'Health Care', 'ABT': 'Health Care', 'LLY': 'Health Care',
                'XOM': 'Energy', 'CVX': 'Energy',
                'PG': 'Consumer Staples', 'KO': 'Consumer Staples', 'WMT': 'Consumer Staples', 'COST': 'Consumer Staples', 'NKE': 'Consumer Discretionary'
            };
            return sectors[symbol] || 'Information Technology';
        }

        // Helper function to get company name for symbol
        function getCompanyNameForSymbol(symbol) {
            const company = sp500CompaniesData.find(c => c.symbol === symbol);
            return company ? company.company_name : symbol;
        }

        // Get Y-axis label based on selected mode
        function getYAxisLabel() {
            const yAxisMode = document.getElementById('y-axis-mode').value;
            
            switch(yAxisMode) {
                case 'confidence': return 'Confidence / Price Change (%)';
                case 'price-change': return 'Price Change (%)';
                case 'surprise-percent': return 'Earnings Surprise (%)';
                case 'eps-growth': return 'EPS Growth (%)';
                case 'market-cap': return 'Market Cap (Log Scale)';
                default: return 'Value';
            }
        }

        // Calculate Y position based on selected mode
        function getYPosition(d, yScale) {
            const yAxisMode = document.getElementById('y-axis-mode').value;
            
            switch(yAxisMode) {
                case 'confidence':
                    if (d.type === 'future') {
                        // Map confidence (0.0-1.0) to y-axis range (-10 to +10)
                        const confidence = d.confidence || 0.5;
                        return yScale((confidence - 0.5) * 20);
                    } else {
                        // For past earnings, use price change
                        const priceChange = d.priceChange || 0;
                        return yScale(priceChange);
                    }
                    
                case 'price-change':
                    const priceChange = d.priceChange || 0;
                    return yScale(priceChange);
                    
                case 'surprise-percent':
                    if (d.type === 'past') {
                        const surprise = d.surprise_percent || 0;
                        return yScale(surprise);
                    } else {
                        // For future, use confidence scaled to surprise range
                        const confidence = d.confidence || 0.5;
                        return yScale((confidence - 0.5) * 20);
                    }
                    
                case 'eps-growth':
                    if (d.actualEPS && d.expectedEPS) {
                        const growth = ((d.actualEPS - d.expectedEPS) / Math.abs(d.expectedEPS)) * 100;
                        return yScale(growth);
                    } else {
                        return yScale(0);
                    }
                    
                case 'market-cap':
                    // Log scale for market cap positioning
                    const marketCap = d.marketCap || 100;
                    const logPosition = Math.log10(marketCap / 100) * 5; // Scale to -10 to +10 range
                    return yScale(Math.max(-10, Math.min(10, logPosition)));
                    
                default:
                    return yScale(0);
            }
        }

        // Initialize timeline with real data
        async function initializeTimeline() {
            const svg = d3.select('#timeline');
            const container = document.querySelector('.timeline-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg.attr('width', width).attr('height', height);
            
            // Show loading indicator
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', '#64ffda')
                .attr('class', 'loading-text')
                .text('Loading real earnings data...');
            
            try {
                const data = await generateRealData();
                const now = new Date();
                
                // Remove loading indicator
                svg.select('.loading-text').remove();
                
                // Scales
                const xScale = d3.scaleTime()
                    .domain(d3.extent(data, d => d.date))
                    .range([50, width - 50]);
                
                const yScale = d3.scaleLinear()
                    .domain([-15, 15])
                    .range([height - 100, 100]);
                
                // Current date line
                svg.append('line')
                    .attr('class', 'current-date-line')
                    .attr('x1', xScale(now))
                    .attr('x2', xScale(now))
                    .attr('y1', 50)
                    .attr('y2', height - 50);
                
                // Earnings icons
                const icons = svg.selectAll('.earnings-icon')
                    .data(data)
                    .enter()
                    .append('circle')
                    .attr('class', d => `earnings-icon ${d.type}-icon`)
                    .attr('data-symbol', d => d.symbol)
                    .attr('cx', d => xScale(d.date))
                    .attr('cy', d => {
                        return getYPosition(d, yScale);
                    })
                    .attr('r', d => {
                        const sizeMode = document.getElementById('icon-size').value;
                        switch(sizeMode) {
                            case 'market-cap': return (Math.sqrt(d.marketCap || 1000) / 10) * 3;
                            case 'volume': return (Math.sqrt(d.volume || 1000000) / 1000) * 3;
                            default: return 18; // 6 * 3 = 18
                        }
                    })
                    .attr('fill', d => {
                        if (d.type === 'past') {
                            // Color based on EPS beat/miss for real data
                            if (d.eps && d.epsEstimate) {
                                return d.eps > d.epsEstimate ? '#4444ff' : '#ff4444';
                            }
                            // Fallback to prediction accuracy
                            if (d.predictionAccuracy > 0.7) return '#4444ff';
                            if (d.predictionAccuracy > 0.4) return '#888888';
                            return '#ff4444';
                        } else {
                            if (d.confidence > 0.7) return '#6bcf7f';
                            if (d.confidence > 0.4) return '#ffd93d';
                            return '#ff6b6b';
                        }
                    })
                    .on('mouseover', showTooltip)
                    .on('mouseout', hideTooltip)
                    .on('click', pinInfo);
                
                // Add axes
                const xAxis = d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y'));
                svg.append('g')
                    .attr('class', 'x-axis')
                    .attr('transform', `translate(0, ${height - 80})`)
                    .call(xAxis)
                    .attr('color', '#666');
                
                const yAxis = d3.axisLeft(yScale);
                svg.append('g')
                    .attr('class', 'y-axis')
                    .attr('transform', 'translate(40, 0)')
                    .call(yAxis)
                    .attr('color', '#666');
                
                // Add axis labels
                svg.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 15)
                    .attr('x', -(height / 2))
                    .style('text-anchor', 'middle')
                    .style('fill', '#666')
                    .style('font-size', '12px')
                    .text(getYAxisLabel());
                
                svg.append('text')
                    .attr('class', 'axis-label')
                    .attr('x', width / 2)
                    .attr('y', height - 40)
                    .style('text-anchor', 'middle')
                    .style('fill', '#666')
                    .style('font-size', '12px')
                    .text('Earnings Date');
                
                // Add zoom functionality
                addZoomPan(svg, xScale, yScale, data);
                    
                // Update ticker with real data after timeline loads
                await updateTickerWithRealData();
                
                console.log(`Timeline initialized with ${data.length} earnings events`);
                console.log(`Real market data loaded for ${Object.keys(realTickerData).length} stocks`);
                
            } catch (error) {
                console.error('Error initializing timeline:', error);
                svg.select('.loading-text').text('Error loading data. Check console for details.');
            }
        }
        
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            
            // Clear any previous content first
            tooltip.innerHTML = '';
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            
            // Build content from scratch for this specific data item
            let content = `
                <strong>${d.symbol}</strong><br>
                ${d.company_name ? d.company_name + '<br>' : ''}
                Date: ${d.date.toLocaleDateString()}<br>
                Sector: ${d.sector}<br>
                Market Cap: $${(d.marketCap || 1000).toFixed(1)}B<br>
            `;
            
            // Ensure we're checking the correct type for THIS specific data item
            if (d.type === 'past') {
                content += `
                    <strong>PAST EARNINGS:</strong><br>
                    Price Change: ${d.priceChange !== null ? (d.priceChange > 0 ? '+' : '') + d.priceChange.toFixed(2) + '%' : 'N/A'}<br>
                    Result: <strong>${d.beat_miss_meet || 'N/A'}</strong><br>
                    Actual EPS: $${d.actualEPS !== null ? d.actualEPS.toFixed(2) : 'N/A'}<br>
                    Expected EPS: $${d.expectedEPS !== null ? d.expectedEPS.toFixed(2) : 'N/A'}<br>
                    Surprise: ${d.surprise_percent !== null ? (d.surprise_percent > 0 ? '+' : '') + d.surprise_percent.toFixed(1) + '%' : 'N/A'}<br>
                    <a href="${d.source_url || d.marketCapDataSource || d.priceChangeDataSource || '#'}" target="_blank" style="color: #64ffda; font-size: 11px;">📊 Data Source</a>
                `;
            } else if (d.type === 'future') {
                const expectation = d.analystExpectation || 'meet';
                content += `
                    <strong>FUTURE EARNINGS:</strong><br>
                    Analyst Expectation: <strong>${expectation.toUpperCase()}</strong><br>
                    Confidence: ${(d.confidence * 100).toFixed(1)}%<br>
                    Expected EPS: $${d.expectedEPS !== null ? d.expectedEPS.toFixed(2) : 'N/A'}<br>
                    Consensus: ${d.consensusRating || 'N/A'}<br>
                    Timing: ${d.announcement_time || 'N/A'}<br>
                    <a href="${d.source_url || d.marketCapDataSource || d.priceChangeDataSource || '#'}" target="_blank" style="color: #64ffda; font-size: 11px;">📊 Data Source</a>
                `;
            } else {
                // Fallback for any undefined type
                content += `
                    <strong>EARNINGS DATA:</strong><br>
                    Type: ${d.type || 'Unknown'}<br>
                    EPS: $${d.actualEPS || d.expectedEPS || 'N/A'}
                `;
            }
            
            tooltip.innerHTML = content;
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'none';
            // Clear content to prevent any lingering data
            tooltip.innerHTML = '';
        }
        
        function pinInfo(event, d) {
            const pinned = document.createElement('div');
            pinned.className = 'pinned-info';
            pinned.style.left = event.pageX + 'px';
            pinned.style.top = event.pageY + 'px';
            
            let content = `
                <button class="close-btn" onclick="this.parentElement.remove()">×</button>
                <h4>${d.symbol} - ${d.date.toLocaleDateString()}</h4>
                <p><strong>Company:</strong> ${d.company_name || d.symbol}</p>
                <p><strong>Sector:</strong> ${d.sector}</p>
                <p><strong>Market Cap:</strong> ${(d.marketCap || 1000).toFixed(1)}B</p>
                <p><strong>Volume:</strong> ${((d.volume || 50000000) / 1000000).toFixed(1)}M</p>
            `;
            
            if (d.type === 'past') {
                const beatMiss = d.beat_miss_meet || (d.actualEPS !== null && d.expectedEPS !== null ? 
                    (d.actualEPS > d.expectedEPS ? 'BEAT' : 'MISS') : 'N/A');
                
                content += `
                    <p><strong>Price Change:</strong> ${d.priceChange !== null ? (d.priceChange > 0 ? '+' : '') + d.priceChange.toFixed(2) + '%' : 'N/A'}</p>
                    <p><strong>Result:</strong> <span style="color: ${beatMiss === 'BEAT' ? '#4444ff' : beatMiss === 'MISS' ? '#ff4444' : '#888'}">${beatMiss}</span></p>
                    <p><strong>Actual EPS:</strong> $${d.actualEPS !== null ? d.actualEPS.toFixed(2) : 'N/A'}</p>
                    <p><strong>Expected EPS:</strong> $${d.expectedEPS !== null ? d.expectedEPS.toFixed(2) : 'N/A'}</p>
                    <p><strong>Surprise:</strong> ${d.surprise_percent !== null ? (d.surprise_percent > 0 ? '+' : '') + d.surprise_percent.toFixed(1) + '%' : 'N/A'}</p>
                    <p><strong>Confidence Score:</strong> ${((d.predictionAccuracy || 0.5) * 100).toFixed(1)}%</p>
                `;
            } else {
                const expectation = d.analystExpectation || 'meet';
                const daysUntil = Math.ceil((d.date - new Date()) / (1000 * 60 * 60 * 24));
                
                content += `
                    <p><strong>Expectation:</strong> <span style="color: ${expectation === 'beat' ? '#4444ff' : expectation === 'miss' ? '#ff4444' : '#888'}">${expectation.toUpperCase()}</span></p>
                    <p><strong>Confidence:</strong> ${(d.confidence * 100).toFixed(1)}%</p>
                    <p><strong>Expected EPS:</strong> $${d.expectedEPS !== null ? d.expectedEPS.toFixed(2) : 'N/A'}</p>
                    <p><strong>Consensus:</strong> ${d.consensusRating || 'N/A'}</p>
                    <p><strong>Timing:</strong> ${d.announcement_time || 'N/A'}</p>
                    <p><strong>Days Until:</strong> ${daysUntil > 0 ? daysUntil : 'Past'}</p>
                `;
            }
            
            // Add data source link for both past and future earnings
            content += `
                <p><a href="${d.source_url || d.marketCapDataSource || d.priceChangeDataSource || '#'}" target="_blank" style="color: #64ffda; text-decoration: none;">📊 Data Source</a></p>
            `;
            
            pinned.innerHTML = content;
            document.body.appendChild(pinned);
            
            // Make draggable
            makeDraggable(pinned);
        }
        
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Company Search Functions
        function setupCompanySearch() {
            const searchInput = document.getElementById('company-search');
            const autocompletePanel = document.getElementById('autocomplete-panel');
            
            if (!searchInput || !autocompletePanel) {
                console.warn('Company search elements not found');
                return;
            }
            
            // Variables to track current state
            let currentHighlightedCompanies = [];
            
            // Handle input changes
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim().toUpperCase();
                
                if (searchTerm.length === 0) {
                    hideAutocompletePanel();
                    clearHighlights();
                    return;
                }
                
                // Filter companies that match the search term
                const matchingCompanies = sp500CompaniesData.filter(company => 
                    company.symbol.toUpperCase().startsWith(searchTerm)
                ).slice(0, 10); // Limit to 10 results
                
                if (matchingCompanies.length > 0) {
                    showAutocompletePanel(matchingCompanies);
                    highlightMatchingEarnings(matchingCompanies.map(c => c.symbol));
                } else {
                    hideAutocompletePanel();
                    clearHighlights();
                }
            });
            
            // Handle click outside to close
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompletePanel.contains(e.target)) {
                    hideAutocompletePanel();
                    clearHighlights();
                }
            });
            
            // Handle escape key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAutocompletePanel();
                    clearHighlights();
                    searchInput.blur();
                }
            });
            
            function showAutocompletePanel(companies) {
                autocompletePanel.innerHTML = '';
                
                companies.forEach(company => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    
                    const symbol = company.symbol || 'N/A';
                    const name = company.company_name || 'Unknown Company';
                    const sector = company.gics_sector || 'Unknown Sector';
                    const subIndustry = company.gics_sub_industry || 'Unknown Sub-Industry';
                    
                    item.innerHTML = `
                        <div class="autocomplete-symbol">${symbol}</div>
                        <div class="autocomplete-name">${name}</div>
                        <div class="autocomplete-sector">${sector} / ${subIndustry}</div>
                    `;
                    
                    // Handle click on autocomplete item
                    item.addEventListener('click', function() {
                        searchInput.value = symbol;
                        hideAutocompletePanel();
                        // Keep highlighting the selected company
                        highlightMatchingEarnings([symbol]);
                    });
                    
                    autocompletePanel.appendChild(item);
                });
                
                autocompletePanel.style.display = 'block';
            }
            
            function hideAutocompletePanel() {
                autocompletePanel.style.display = 'none';
            }
            
            function highlightMatchingEarnings(symbols) {
                // Clear previous highlights
                clearHighlights();
                
                // Store current highlighted companies
                currentHighlightedCompanies = symbols;
                
                // Find and highlight matching earnings icons
                const timelineSvg = document.querySelector('#timeline');
                if (!timelineSvg) return;
                
                symbols.forEach(symbol => {
                    const earningsIcons = timelineSvg.querySelectorAll(`circle[data-symbol="${symbol}"]`);
                    earningsIcons.forEach(icon => {
                        icon.classList.add('highlighted');
                        // Bring highlighted icons to front by moving them to end of parent
                        icon.parentNode.appendChild(icon);
                    });
                });
            }
            
            function clearHighlights() {
                const timelineSvg = document.querySelector('#timeline');
                if (!timelineSvg) return;
                
                const highlightedIcons = timelineSvg.querySelectorAll('.highlighted');
                highlightedIcons.forEach(icon => {
                    icon.classList.remove('highlighted');
                });
                
                currentHighlightedCompanies = [];
            }
        }

        // MCP Tool Functions
        function performSentimentAnalysis() {
            alert('Sentiment Analysis MCP Server would analyze current market sentiment across news, social media, and analyst reports for visible companies.');
        }
        
        function findSimilarCompanies() {
            alert('Similar Companies MCP Server would identify companies with similar business models, financials, or market behavior patterns.');
        }
        
        function addIPOCompanies() {
            alert('IPO Tracker MCP Server would add recent and upcoming IPOs to the timeline with their earnings schedules.');
        }
        
        function analyzeOptions() {
            alert('Options Analysis MCP Server would provide options flow data and unusual activity around earnings dates.');
        }
        
        function marketCorrelation() {
            alert('Market Correlation MCP Server would show how earnings surprises correlate with broader market movements.');
        }

        // Chat functions - now handled by dashboard-integration.js
        function askQuestion(question) {
            // This function is maintained for compatibility but functionality moved to TypeScript module
            console.log('Question:', question);
        }

        // Function to populate chat input (fallback for quick actions)
        function populateChatInput(question) {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = question;
                chatInput.focus();
                updateSendButtonState();
            }
        }

        // Function to get selected model
        function getSelectedModel() {
            const modelSelect = document.getElementById('model-select');
            const selectedModel = modelSelect?.value || 'qwen:1.8b';
            console.log('Using model:', selectedModel);
            return selectedModel;
        }

        // Function to update send button state based on input content
        function updateSendButtonState() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            
            if (chatInput && sendBtn) {
                const hasText = chatInput.value.trim().length > 0;
                sendBtn.disabled = !hasText;
            }
        }

        // Function to handle model selection change
        function onModelChange() {
            const selectedModel = getSelectedModel();
            addChatMessage(`Switched to model: **${selectedModel}**`, 'assistant');
            console.log('Model changed to:', selectedModel);
            
            // Optionally test if the model is available
            testModelAvailability(selectedModel);
        }

        // Function to test if a model is available
        async function testModelAvailability(modelName) {
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                if (response.ok) {
                    const data = await response.json();
                    const availableModels = data.models?.map(m => m.name) || [];
                    console.log('Available models:', availableModels);
                    
                    if (!availableModels.includes(modelName)) {
                        console.warn(`Model ${modelName} not found in available models`);
                        addChatMessage(`⚠️ Model **${modelName}** not found. Available models: ${availableModels.join(', ')}. Run \`ollama pull ${modelName}\` to install it.`, 'error');
                    } else {
                        console.log(`Model ${modelName} is available`);
                    }
                } else {
                    console.error('Failed to check available models');
                }
            } catch (error) {
                console.error('Error checking model availability:', error);
            }
        }

        // Function to add message to chat history with proper formatting
        function addChatMessage(message, type, timestamp = new Date()) {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;

            const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Format message content with financial data highlighting
            const formattedMessage = formatFinancialMessage(message);
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            let icon, label;
            switch (type) {
                case 'user':
                    icon = '⚔';
                    label = 'You';
                    break;
                case 'assistant':
                    icon = '🦸';
                    label = 'Assistant';
                    break;
                case 'error':
                    icon = '⚠️';
                    label = 'Error';
                    break;
                default:
                    icon = '💬';
                    label = 'System';
            }
            
            messageDiv.innerHTML = `
                <div class="chat-icon ${type}">${icon}</div>
                <div class="chat-message-content">
                    <div class="chat-message-header">
                        ${label}
                        <span class="chat-message-time">${timeStr}</span>
                    </div>
                    <div class="chat-message-text">${formattedMessage}</div>
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Function to add loading message
        function addLoadingMessage() {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return null;

            const loadingId = `loading-${Date.now()}`;
            const messageDiv = document.createElement('div');
            messageDiv.id = loadingId;
            messageDiv.className = 'chat-message loading assistant';
            
            messageDiv.innerHTML = `
                <div class="chat-icon assistant">🦸</div>
                <div class="chat-message-content">
                    <div class="chat-message-header">
                        Assistant
                        <span class="chat-message-time">typing...</span>
                    </div>
                    <div class="chat-message-text">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return loadingId;
        }

        // Function to remove loading message
        function removeLoadingMessage(loadingId) {
            if (loadingId) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
        }

        // Function to format financial messages with highlighting
        function formatFinancialMessage(message) {
            return message
                // Stock symbols (3-5 capital letters)
                .replace(/\b[A-Z]{2,5}\b/g, (match) => {
                    if (!['THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HER', 'WAS', 'ONE', 'OUR', 'HAD', 'OUT', 'DAY', 'GET', 'HAS', 'HIM', 'HOW', 'MAN', 'NEW', 'NOW', 'OLD', 'SEE', 'TWO', 'WAY', 'WHO', 'BOY', 'DID', 'ITS', 'LET', 'PUT', 'SAY', 'SHE', 'TOO', 'USE'].includes(match)) {
                        return `<span class="stock-symbol">${match}</span>`;
                    }
                    return match;
                })
                // Prices ($X.XX format)
                .replace(/\$[\d,]+\.?\d*/g, '<span class="price">$&</span>')
                // Percentages with color coding
                .replace(/([+-]?\d+\.?\d*%)/g, (match) => {
                    const isPositive = match.startsWith('+') || (!match.startsWith('-') && parseFloat(match) > 0);
                    const className = isPositive ? 'percentage positive' : 'percentage negative';
                    return `<span class="${className}">${match}</span>`;
                })
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Line breaks
                .replace(/\n/g, '<br>');
        }

        // Function to send chat message
        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            
            if (!chatInput || !sendBtn) return;
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to history
            addChatMessage(message, 'user');
            
            // Clear input and disable button
            chatInput.value = '';
            updateSendButtonState();
            
            // Show loading indicator
            const loadingId = addLoadingMessage();
            
            // Disable send button during processing
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>Sending...</span>';
            
            try {
                // Check if TypeScript integration is available
                if (window.dashboardIntegration) {
                    // Use the TypeScript integration
                    console.log('Using TypeScript integration for:', message);
                    // The TypeScript module should handle adding the response
                    removeLoadingMessage(loadingId);
                } else {
                    // Fallback to direct Ollama call
                    console.log('Fallback: Sending to Ollama:', message);
                    
                    const response = await fetch('http://localhost:11434/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: getSelectedModel(),
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are an expert financial analyst assistant with deep knowledge of stock markets, earnings analysis, and investment strategies. Provide accurate, actionable insights while maintaining a professional tone.'
                                },
                                {
                                    role: 'user',
                                    content: message
                                }
                            ],
                            stream: false
                        })
                    });
                    
                    removeLoadingMessage(loadingId);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Ollama response:', result);
                        
                        // Extract message content from chat API response
                        const responseText = result.message?.content || result.response || 'No response received';
                        
                        // Add assistant response to history
                        addChatMessage(responseText, 'assistant');
                    } else {
                        console.error('Ollama API error:', response.status, response.statusText);
                        
                        // Try to get error details from response
                        let errorDetails = '';
                        try {
                            const errorData = await response.text();
                            console.error('Ollama error details:', errorData);
                            errorDetails = errorData;
                        } catch (e) {
                            console.error('Could not read error response');
                        }
                        
                        let errorMessage = `Failed to get response from Ollama (Error ${response.status}).`;
                        
                        if (response.status === 404) {
                            errorMessage += ' Please check:\n• Ollama is running: `ollama serve`\n• Model is installed: `ollama pull llama3.1:8b`\n• API is accessible at localhost:11434';
                        } else if (response.status === 500) {
                            errorMessage += ' Internal server error. This often means:\n• Model not found or not loaded\n• Insufficient memory/resources\n• Model name format issue';
                            if (errorDetails) {
                                errorMessage += `\n\nServer response: ${errorDetails}`;
                            }
                            errorMessage += `\n\nTry:\n• \`ollama pull ${getSelectedModel()}\`\n• \`ollama list\` to check available models\n• Restart Ollama: \`ollama serve\``;
                        }
                        
                        addChatMessage(errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                removeLoadingMessage(loadingId);
                addChatMessage(`Could not send message: ${error.message}`, 'error');
            } finally {
                // Restore button state
                sendBtn.innerHTML = '<span>Send</span>';
                updateSendButtonState();
            }
        }

        // Configuration modal
        function openConfigModal() {
            document.getElementById('config-modal').style.display = 'flex';
        }
        
        function closeConfigModal() {
            document.getElementById('config-modal').style.display = 'none';
        }
        
        function saveConfig() {
            // Collect configuration values
            const config = {
                temperature: parseFloat(document.getElementById('temperature').value),
                topP: parseFloat(document.getElementById('top-p').value),
                maxTokens: parseInt(document.getElementById('max-tokens').value),
                contextLength: parseInt(document.getElementById('context-length').value),
                repetitionPenalty: parseFloat(document.getElementById('rep-penalty').value),
                topK: parseInt(document.getElementById('top-k').value),
                seed: parseInt(document.getElementById('seed').value),
                systemPrompt: document.getElementById('system-prompt').value,
                gpuLayers: parseInt(document.getElementById('gpu-layers').value),
                threads: parseInt(document.getElementById('threads').value),
                batchSize: parseInt(document.getElementById('batch-size').value)
            };
            
            console.log('Ollama Configuration:', config);
            // Here you would send this to your Ollama API
            
            closeConfigModal();
            alert('Configuration saved! This would be sent to your Ollama server.');
        }

        // Update slider values
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('temp-value').textContent = this.value;
        });
        
        document.getElementById('top-p').addEventListener('input', function() {
            document.getElementById('top-p-value').textContent = this.value;
        });
        
        document.getElementById('rep-penalty').addEventListener('input', function() {
            document.getElementById('rep-penalty-value').textContent = this.value;
        });

        // Update ticker with real market data
        async function updateTickerWithRealData() {
            const type = document.getElementById('ticker-type').value;
            const ticker = document.getElementById('ticker');
            
            let content = '';
            
            if (type === 'sector' && Object.keys(realTickerData).length > 0) {
                // Group by sector and calculate average performance
                const sectorPerformance = {};
                Object.values(realTickerData).forEach(stock => {
                    const sector = getSectorForSymbol(stock.symbol);
                    if (!sectorPerformance[sector]) {
                        sectorPerformance[sector] = { total: 0, count: 0 };
                    }
                    sectorPerformance[sector].total += stock.changePercent;
                    sectorPerformance[sector].count += 1;
                });
                
                content = Object.entries(sectorPerformance)
                    .map(([sector, data]) => {
                        const avg = (data.total / data.count).toFixed(1);
                        const sign = avg > 0 ? '+' : '';
                        return `<span class="ticker-item">${sector} ${sign}${avg}%</span>`;
                    })
                    .join('');
            } else if (type === 'earnings' && realEarningsData.length > 0) {
                // Show upcoming earnings from real data
                const upcoming = realEarningsData
                    .filter(earning => earning.type === 'future')
                    .sort((a, b) => a.date - b.date)
                    .slice(0, 10);
                    
                content = upcoming
                    .map(earning => {
                        const dateStr = earning.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `<span class="ticker-item">${earning.symbol}: ${dateStr}</span>`;
                    })
                    .join('');
            } else if (Object.keys(realTickerData).length > 0) {
                // Show real stock data
                const sortedStocks = Object.values(realTickerData)
                    .sort((a, b) => {
                        switch(type) {
                            case 'volume': return b.volume - a.volume;
                            default: return b.changePercent - a.changePercent;
                        }
                    })
                    .slice(0, 10);
                
                content = sortedStocks
                    .map(stock => {
                        if (type === 'volume') {
                            const volumeM = (stock.volume / 1000000).toFixed(1);
                            return `<span class="ticker-item">${stock.symbol} ${volumeM}M vol</span>`;
                        } else {
                            const sign = stock.changePercent > 0 ? '+' : '';
                            return `<span class="ticker-item">${stock.symbol} ${sign}${stock.changePercent.toFixed(1)}%</span>`;
                        }
                    })
                    .join('');
            } else {
                // Fallback to static content
                content = getFallbackTickerContent(type);
            }
            
            ticker.innerHTML = content || '<span class="ticker-item">Loading market data...</span>';
        }

        // Fallback ticker content when real data isn't available
        function getFallbackTickerContent(type) {
            switch(type) {
                case 'sector':
                    return '<span class="ticker-item">Technology +1.8%</span><span class="ticker-item">Healthcare +0.9%</span><span class="ticker-item">Financial +2.1%</span><span class="ticker-item">Energy -1.2%</span><span class="ticker-item">Consumer +0.7%</span>';
                case 'earnings':
                    return '<span class="ticker-item">AAPL: Jul 15</span><span class="ticker-item">MSFT: Jul 16</span><span class="ticker-item">GOOGL: Jul 17</span><span class="ticker-item">TSLA: Jul 18</span><span class="ticker-item">AMZN: Jul 19</span>';
                case 'volume':
                    return '<span class="ticker-item">NVDA 45.2M vol</span><span class="ticker-item">AAPL 38.1M vol</span><span class="ticker-item">TSLA 31.7M vol</span><span class="ticker-item">AMD 28.3M vol</span>';
                case 'news':
                    return '<span class="ticker-item">📈 AI stocks surge on chip demand</span><span class="ticker-item">📊 Q2 earnings beat expectations</span><span class="ticker-item">🏦 Fed signals rate stability</span>';
                case 'social':
                    return '<span class="ticker-item">🔥 #NVDA trending</span><span class="ticker-item">📱 #AAPL iPhone buzz</span><span class="ticker-item">🚗 #TSLA autonomous driving</span>';
                default:
                    return '<span class="ticker-item">Market data unavailable</span>';
            }
        }

        // Legacy function for compatibility
        function updateTicker() {
            updateTickerWithRealData();
        }
        
        document.getElementById('ticker-type').addEventListener('change', updateTicker);

        // Icon size change handler
        document.getElementById('icon-size').addEventListener('change', function() {
            // Redraw timeline with new sizing
            d3.select('#timeline').selectAll('*').remove();
            initializeTimeline();
        });
        
        // Y-axis mode change handler
        document.getElementById('y-axis-mode').addEventListener('change', function() {
            // Redraw timeline with new y-axis positioning
            d3.select('#timeline').selectAll('*').remove();
            initializeTimeline();
        });

        // Color scheme change handler
        document.getElementById('color-scheme').addEventListener('change', function() {
            const scheme = this.value;
            // Update CSS variables or redraw with new colors
            console.log('Color scheme changed to:', scheme);
        });

        // Portfolio management
        function addToPortfolio(symbol, listName) {
            console.log(`Adding ${symbol} to ${listName} portfolio`);
            // Here you would integrate with portfolio management system
        }

        // Responsive handling
        function handleResize() {
            d3.select('#timeline').selectAll('*').remove();
            initializeTimeline();
        }
        
        window.addEventListener('resize', debounce(handleResize, 250));
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Timeline zoom and pan functionality with proper axis scaling
        function addZoomPan(svg, xScale, yScale, data) {
            // Create zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.5, 10])  // Allow zooming from 0.5x to 10x
                .on('zoom', function(event) {
                    const { transform } = event;
                    
                    // Create new scaled x-axis (only zoom on x-axis, keep y-axis fixed)
                    const newXScale = transform.rescaleX(xScale);
                    
                    // Update earnings icons with new x positions and recalculate y positions
                    svg.selectAll('.earnings-icon')
                        .attr('cx', d => newXScale(d.date))
                        .attr('cy', d => getYPosition(d, yScale));
                    
                    // Update current date line position
                    const now = new Date();
                    svg.selectAll('.current-date-line')
                        .attr('x1', newXScale(now))
                        .attr('x2', newXScale(now));
                    
                    // Update x-axis
                    svg.select('.x-axis')
                        .call(d3.axisBottom(newXScale).tickFormat(d3.timeFormat('%b %Y')));
                    
                    // Update y-axis label if needed
                    svg.selectAll('.axis-label')
                        .filter(function() { return d3.select(this).attr('transform') === 'rotate(-90)'; })
                        .text(getYAxisLabel());
                });
            
            svg.call(zoom);
        }

        // Load real S&P 500 data from API
        async function loadSP500Data() {
            try {
                console.log('📡 Fetching all 503 S&P 500 companies from API...');
                
                // Fetch company symbols
                const symbolsResponse = await fetch(`${API_CONFIG.SP500_API}/symbols`);
                if (!symbolsResponse.ok) {
                    throw new Error(`HTTP error! status: ${symbolsResponse.status}`);
                }
                const symbolsData = await symbolsResponse.json();
                sp500Companies = symbolsData.symbols;
                
                // Fetch full company data
                const companiesResponse = await fetch(`${API_CONFIG.SP500_API}/companies`);
                if (!companiesResponse.ok) {
                    throw new Error(`HTTP error! status: ${companiesResponse.status}`);
                }
                const companiesData = await companiesResponse.json();
                sp500CompaniesData = companiesData.companies;
                
                // Fetch sectors data
                const sectorsResponse = await fetch(`${API_CONFIG.SP500_API}/sectors`);
                if (!sectorsResponse.ok) {
                    throw new Error(`HTTP error! status: ${sectorsResponse.status}`);
                }
                const sectorsData = await sectorsResponse.json();
                sp500SectorsData = sectorsData.sectors;
                
                console.log(`✅ Loaded ${sp500Companies.length} S&P 500 companies from API`);
                console.log(`📊 Loaded ${sp500SectorsData.length} sectors`);
                console.log(`📅 Data last updated: ${companiesData.last_update}`);
                
                return sp500Companies;
                
            } catch (error) {
                console.error('❌ Error loading S&P 500 data from API:', error);
                console.log('🔄 Falling back to basic company list...');
                
                // Fallback to a basic list for demo purposes
                sp500Companies = [
                    'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM', 'JNJ', 'V',
                    'PG', 'UNH', 'HD', 'MA', 'PFE', 'BAC', 'XOM', 'DIS', 'ADBE', 'CRM',
                    'NFLX', 'KO', 'VZ', 'INTC', 'CSCO', 'ABT', 'PEP', 'TMO', 'AVGO', 'ACN'
                ];
                return sp500Companies;
            }
        }

        // MCP Server integration points
        const mcpServers = {
            sentimentAnalysis: {
                endpoint: 'http://localhost:3001/sentiment',
                description: 'Analyzes sentiment from news and social media'
            },
            similarCompanies: {
                endpoint: 'http://localhost:3002/similar',
                description: 'Finds companies with similar characteristics'
            },
            ipoTracker: {
                endpoint: 'http://localhost:3003/ipo',
                description: 'Tracks IPO companies and their earnings schedules'
            },
            optionsAnalysis: {
                endpoint: 'http://localhost:3004/options',
                description: 'Provides options flow and unusual activity data'
            },
            marketCorrelation: {
                endpoint: 'http://localhost:3005/correlation',
                description: 'Analyzes market correlations and dependencies'
            }
        };

        // Ollama integration - now handled by dashboard-integration.js
        // Legacy functions maintained for compatibility

        // Populate portfolio section with real sector data
        function populatePortfolioSectors() {
            const portfolioList = document.getElementById('portfolio-list');
            if (!portfolioList || sp500SectorsData.length === 0) return;
            
            // Clear loading message
            portfolioList.innerHTML = '';
            
            // Sort sectors by company count (descending)
            const sortedSectors = sp500SectorsData
                .sort((a, b) => b.company_count - a.company_count)
                .slice(0, 5); // Show top 5 sectors
            
            sortedSectors.forEach(sector => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.style.cursor = 'pointer';
                
                // Color code by sector type
                let typeClass = 'Real';
                let typeColor = '#4a90e2';
                if (sector.company_count > 70) {
                    typeClass = 'Large';
                    typeColor = '#6bcf7f';
                } else if (sector.company_count < 30) {
                    typeClass = 'Small';
                    typeColor = '#ff6b6b';
                }
                
                listItem.innerHTML = `
                    <div class="list-header">
                        <span class="list-name">${sector.sector_name}</span>
                        <span class="list-type" style="background: ${typeColor}">${typeClass}</span>
                    </div>
                    <div class="stock-count">${sector.company_count} companies</div>
                `;
                
                // Add click handler to filter by sector
                listItem.addEventListener('click', () => {
                    console.log(`Filtering by sector: ${sector.sector_name}`);
                    filterBySector(sector.sector_name);
                });
                
                portfolioList.appendChild(listItem);
            });
            
            console.log(`📊 Populated portfolio with ${sortedSectors.length} sectors`);
        }
        
        // Filter functions for sectors
        function filterBySector(sectorName) {
            console.log(`🔍 Filtering timeline by sector: ${sectorName}`);
            // This could be implemented to filter the timeline by sector
            // For now, just log the action
            addChatMessage(`Showing companies in sector: **${sectorName}**`, 'assistant');
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Load configuration first (API keys and endpoints)
            await loadConfig();
            
            // Load S&P 500 data first
            await loadSP500Data();
            
            // Populate portfolio section with sector data
            populatePortfolioSectors();
            
            // Initialize timeline with real data (async)
            await initializeTimeline();
            
            // Update ticker (will use real data if available)
            updateTicker();
            
            // Zoom functionality is now added during timeline initialization
            
            // Setup company search autocomplete
            setupCompanySearch();
            
            // Setup chat input and send button event listeners
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const modelSelect = document.getElementById('model-select');
            
            if (chatInput) {
                // Update button state on input
                chatInput.addEventListener('input', updateSendButtonState);
                chatInput.addEventListener('keyup', updateSendButtonState);
                
                // Handle Enter key (existing functionality)
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!sendBtn.disabled) {
                            sendChatMessage();
                        }
                    }
                });
            }
            
            if (sendBtn) {
                // Handle button click
                sendBtn.addEventListener('click', sendChatMessage);
            }

            if (modelSelect) {
                // Handle model selection change
                modelSelect.addEventListener('change', onModelChange);
                
                // Log initial model selection
                console.log('Initial model:', getSelectedModel());
            }
            
            // Initial button state
            updateSendButtonState();
            
            console.log('Stock Market Earnings Analysis Dashboard initialized');
            console.log('MCP Servers configured:', Object.keys(mcpServers));
            console.log('Ready for Ollama integration on localhost:11434');
        });

        // Additional utility functions for future development
        function exportPortfolio(listName) {
            console.log(`Exporting ${listName} portfolio data`);
            // Export portfolio data as CSV/JSON
        }
        
        function importPortfolio(file) {
            console.log('Importing portfolio from file:', file.name);
            // Import portfolio data from file
        }
        
        function scheduleAlert(symbol, date, type) {
            console.log(`Scheduling ${type} alert for ${symbol} on ${date}`);
            // Schedule earnings alert
        }
        
        function generateReport(portfolioName, timeframe) {
            console.log(`Generating ${timeframe} report for ${portfolioName}`);
            // Generate performance report
        }

        // WebSocket connection for real-time updates (future enhancement)
        function initializeWebSocket() {
            // Connect to real-time data feed
            // const ws = new WebSocket('ws://localhost:8080/realtime');
            console.log('WebSocket for real-time updates would be initialized here');
        }

        // Service Worker for offline functionality (future enhancement)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>
</body>
</html>
